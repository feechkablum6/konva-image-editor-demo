# AGENTS.md — правила для агентных ассистентов
Этот файл фиксирует команды, стиль и продуктовый контекст для работы в репозитории.

## 1) Контекст проекта
- Репозиторий: `konva-image-editor-demo`.
- Формат: демо-версия для клиента с Kwork.
- Стек: Vue 3 (`<script setup>`), Vite, Konva, vue-konva.
- Тип: frontend-only, backend в текущем репо отсутствует.
- Цель: редактор изображений с блоками на canvas.
- Архитектура: thin `src/App.vue` + composable `src/composables/useImageEditor.js` + helper-модули `src/editor/*`.

### Основная задача продукта
Нужно поддержать следующие возможности:
1. Добавление на канвас блоков с изображениями.
2. Поддержка разных расширений файлов (`image/*`, множественный upload).
3. Загрузчики файлов и удобный поток добавления изображений.
4. Экспорт изображения в JPEG/PNG/WebP с quality и размером.
5. Импорт/экспорт состояния редактора в JSON.
6. Кроппер при загрузке: обрезка, масштаб, resize, поворот.
7. Те же операции кропа и трансформаций после загрузки.
8. Отражение изображения по горизонтали/вертикали.
9. Цветокоррекция: brightness, contrast, saturation, hue.
10. Рисование/ретушь: кисть, ластик (MVP), возможное расширение.
11. Работа с текстом: добавление и редактирование надписей.
12. Работа с цветом: picker + EyeDropper API при поддержке браузера.
13. История изменений: undo/redo на 5 шагов.

## 2) Проверка Cursor/Copilot правил
- Проверены пути: `.cursor/rules/`, `.cursorrules`, `.github/copilot-instructions.md`.
- На момент анализа в репозитории они отсутствуют.
- Если появятся, добавить их требования в этот документ и соблюдать приоритетно.

## 3) Команды проекта
### Установка зависимостей
```bash
npm install
```
### Локальная разработка
```bash
npm run dev
```
### Production build
```bash
npm run build
```
### Preview собранной версии
```bash
npm run preview
```
### Lint/Test текущее состояние
- `lint`-скрипт отсутствует.
- Prettier-конфиг отсутствует.
- Тестовый раннер (Vitest/Jest) не подключен.
- Тестовые файлы `*.spec.*` / `*.test.*` не найдены.

### Запуск одного теста (single test)
Сейчас штатный запуск одного теста невозможен, так как тестовая инфраструктура отсутствует.
Если в задаче добавлен Vitest, использовать формат:
```bash
npx vitest run path/to/file.spec.js -t "test name"
```
Нельзя заявлять, что тесты пройдены, если раннер не настроен.

## 4) Карта важных файлов
- `src/main.js` — вход в приложение.
- `src/App.vue` — UI-шаблон и подключение `useImageEditor`.
- `src/composables/useImageEditor.js` — основная логика редактора, состояние и обработчики Konva.
- `src/editor/number.js` — числовые утилиты (`toNumber`, `clamp`).
- `src/editor/lineState.js` — операции с линиями, snapshot/hydrate/serialize для image-блоков.
- `src/editor/placeholders.js` — генерация demo/default изображений для блоков.
- `src/editor/download.js` — экспортные helper-функции скачивания и mime->extension.
- `src/styles/app-editor.css` — scoped-стили экрана редактора (подключены из `App.vue`).
- `src/style.css` — базовые глобальные стили приложения.
- `vite.config.js` — конфигурация сборки.
- `docs/assets/` — сгенерированные артефакты, вручную не править.

## 5) Стиль кода
### JavaScript и Vue
- Использовать Composition API и `<script setup>`.
- Отступы: 2 пробела.
- Кавычки: одинарные.
- Следовать текущему стилю без `;`.
- Предпочитать `const`, `let` только при необходимости.
- Предпочитать guard clauses и ранние `return`.
- Для async логики использовать `async/await`.

### Импорты
- Порядок: `vue` -> внешние пакеты -> локальные модули/стили.
- Не оставлять неиспользуемые импорты.

### Модульность
- В `src/App.vue` держать только template и биндинг к composable.
- Основную бизнес-логику редактора хранить в `src/composables/useImageEditor.js`.
- Переиспользуемые чистые функции выносить в `src/editor/*`.
- Не возвращать из composable неиспользуемые в шаблоне биндинги.

### Нейминг
- Константы верхнего уровня: `UPPER_SNAKE_CASE`.
- Функции/переменные: `camelCase`.
- Ссылки (`ref`) именовать с суффиксом `Ref`.
- Булевы флаги именовать с `is/has/can`.
- ID сущностей генерировать через `createId(prefix)`.

### Типы и валидация
- Проект на JS, поэтому входные данные валидировать вручную.
- Числа нормализовать через `toNumber` и `clamp`.
- Ограничивать диапазоны для размеров, rotation, quality, pixel ratio.
- Не доверять данным из импорта JSON и файлов без проверок.

### Ошибки
- Файловые операции, импорт/экспорт и кроппер оборачивать в `try/catch`.
- Сообщения пользователю показывать через `setNotice(...)`.
- Ошибки должны быть короткими и конкретными.
- Не скрывать ошибки в истории, экспорте и импорте.

### Состояние и реактивность
- Коллекции хранить в `ref([])`.
- Связанные поля хранить в `reactive({...})`.
- Производные значения хранить в `computed`.
- После изменений узлов Konva использовать `nextTick(...)`, когда нужно.
- После значимых действий сохранять снимок через `pushHistory()`.

### Konva/canvas практики
- Синхронизировать выделение и трансформации через transformer.
- После смены фильтров/изображения обновлять cache узла.
- Инструменты select/pen/erase/pan не должны конфликтовать.
- Минимальный размер блока при трансформации: 20px.

### UI и CSS
- Сохранять текущий визуальный стиль проекта.
- Не упрощать интерфейс до шаблонного базового вида.
- Поддерживать desktop и mobile сценарии.
- Добавлять стили согласованно с существующими переменными и секциями.

## 6) Правила внесения изменений
- Делать минимальные необходимые изменения без лишнего рефакторинга.
- Не ломать существующие сценарии демо.
- Не переименовывать UI-элементы без веской причины.
- Перед новой реализацией искать аналогичный паттерн в `src/App.vue` и `src/composables/useImageEditor.js`.
- Новую логику редактора добавлять в composable/модули, а не раздувать `<script setup>` в `App.vue`.
- Изменения стилей редактора вносить в `src/styles/app-editor.css`; `src/style.css` использовать для глобальных правил.
- Поддерживать обратную совместимость snapshot JSON структуры.

## 7) Проверка перед завершением задачи
1. `npm run build` проходит успешно.
2. Upload/crop/export/undo-redo работают без регрессий.
3. Select/transform/pan/brush/eraser не конфликтуют.
4. В отчете нет ложных утверждений о тестах и линте.
5. `App.vue` остается UI-слоем без возврата к монолитной логике.

## 8) Вопросы к заказчику при расширении MVP
1. Нужны ли полноценные clone/heal инструменты?
2. Какие лимиты по размеру и весу экспортируемых файлов?
3. Нужны ли готовые пресеты экспорта под площадки?
4. Нужна ли поддержка HEIC/TIFF через конвертацию?
5. Какие браузеры обязательны для поддержки EyeDropper и canvas?

## 9) Демо-сценарий показа клиенту
1. Добавить блок через `Add block` или `Upload image(s)`.
2. Показать кроппер: `Centered square`, rotation, `Apply crop`.
3. Выполнить drag/resize/rotate и `Flip X`/`Flip Y`.
4. Изменить brightness/contrast/saturation/hue.
5. Включить `Brush`, затем `Eraser`.
6. Добавить `Add text`, изменить текст/цвет/размер.
7. Продемонстрировать `Undo/Redo` (до 5 шагов).
8. Экспортировать в PNG/JPEG/WebP с разным quality и размером.

Проект демонстрационный: любая доработка должна повышать наглядность показа клиенту.
